FROM elixir:1.17.0-rc.0-otp-27-alpine AS base
ARG MIX_ENV
ENV MIX_ENV ${MIX_ENV:-test}
RUN apk --no-cache add git build-base && \
    adduser -D user && \
    mkdir -p /usr/src/project && \
    chown user:user /usr/src/project
USER user
WORKDIR /usr/src/project
RUN mix local.hex --force && \
    mix local.rebar --force


FROM base AS build
COPY --chown=user VERSION .
COPY --chown=user mix.exs .
COPY --chown=user mix.lock .
RUN mix deps.get && \
    mix deps.compile && \
    mix compile


FROM base AS dev
COPY --chown=user --from=build /usr/src/project/deps deps
COPY --chown=user --from=build /usr/src/project/_build _build
COPY --chown=user . .
RUN git submodule update --init
CMD ["iex", "-S", "mix"]
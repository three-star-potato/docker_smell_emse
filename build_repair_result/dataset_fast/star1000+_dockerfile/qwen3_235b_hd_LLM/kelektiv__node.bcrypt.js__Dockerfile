ARG FROM_IMAGE=node:18-bullseye
FROM ${FROM_IMAGE}

ENV project bcrypt-js
ENV DEBIAN_FRONTEND noninteractive
ENV LC_ALL en_US.UTF-8
ENV LANG ${LC_ALL}

RUN echo "#log: ${project}: Setup system" \
  && set -x \
  && apt-get update -y \
  && apt-get install -y --no-install-recommends \
    build-essential \
    python3 \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/* \
  && update-alternatives --install /usr/local/bin/python python /usr/bin/python3 20 \
  && npm i -g prebuildify@5 node-gyp@9 \
  && sync

COPY . /usr/local/opt/${project}
WORKDIR /usr/local/opt/${project}

RUN echo "#log: ${project}: Running build" \
  && set -x \
  && npm ci \
  && npm run build

ARG RUN_TESTS=true
ARG TEST_TIMEOUT_SECONDS=

RUN if [ "${RUN_TESTS}" = "true" ]; then \
    echo "#log: ${project}: Running tests" \
    && npm test; \
  else \
    echo "#log: ${project}: Tests were skipped!"; \
  fi

CMD ["/bin/bash", "-l"]
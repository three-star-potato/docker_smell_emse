FROM python:3.11.4-alpine

RUN apk add --no-cache \
  curl \
  gcc \
  musl-dev \
  git \
  g++ \
  libffi-dev \
  postgresql-dev \
  mariadb-dev \
  ncurses \
  bash && \
  adduser --disabled-password fastapi_template && \
  mkdir /projects /src && \
  chown -R fastapi_template:fastapi_template /projects /src

USER fastapi_template

WORKDIR /src

ENV PATH=${PATH}:/home/fastapi_template/.local/bin

COPY . /src/
RUN pip install --no-cache-dir poetry==1.5.1 && \
  pip install --no-cache-dir . && \
  rm -rfv /src

USER root

RUN apk del curl

USER fastapi_template

RUN git config --global user.name "Fastapi Template" && \
  git config --global user.email "fastapi-template@no-reply.com"

VOLUME /projects
WORKDIR /projects

ENTRYPOINT ["/home/fastapi_template/.local/bin/fastapi_template"]
# This image is only intended to run the tests

FROM ubuntu:22.04 AS base

RUN apt-get -qq update && \
    apt-get -qq --no-install-recommends install -y sbcl curl gcc libpng-dev git && rm -rf /var/lib/apt/lists/*;

WORKDIR /opt
RUN curl -f -L -s 'https://beta.quicklisp.org/quicklisp.lisp' -o /opt/quicklisp.lisp
RUN sbcl --noinform --load /opt/quicklisp.lisp\
         --eval '(quicklisp-quickstart:install :path "/opt/quicklisp")'\
         --eval '(sb-ext:quit)'

RUN mkdir -p quicklisp
# &&\
    # ln -s /opt/quicklisp/setup.lisp quicklisp/setup.lisp
RUN mkdir -p /opt/data
RUN apt-get -qq remove curl -y &&\
    apt-get -qq autoremove -y &&\
    apt-get -qq autoclean -y

FROM base AS build

WORKDIR /opt
COPY src quicklisp/local-projects/weird/src
COPY test quicklisp/local-projects/weird/test
COPY weird.asd quicklisp/local-projects/weird
COPY run-tests.sh quicklisp/local-projects/weird/run-tests.sh
RUN mkdir -p ~/quicklisp/ && ln -s /opt/quicklisp/setup.lisp ~/quicklisp/setup.lisp

RUN git clone https://github.com/inconvergent/cl-veq.git quicklisp/local-projects/veq

WORKDIR /opt/quicklisp/local-projects/weird

CMD ["bash", "./run-tests.sh"]